<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Mi Biblioteca</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg: #f5f3ef;
    --card: #fff8f0;
    --muted: #6b5e4d;
    --accent: #c49a6c;
    --shelf-bg: url('https://images.unsplash.com/photo-1595526113122-9e8e196ecda3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNjA3fDB8MHwxfHNlYXJjaHwxfHx3b29kJTIwc2hlbGYlMjBib29rc3xlbnwwfHx8fDE2OTU4MjM2MzY&ixlib=rb-4.0.3&q=80&w=400') center/cover no-repeat;
  }

  body {
    font-family: 'Georgia', serif;
    margin: 0;
    padding: 20px;
    background: var(--bg);
    color: #3e3a36;
  }

  header {
    text-align: center;
    margin-bottom: 20px;
  }

  h1 {
    margin: 0;
    font-size: 28px;
    color: var(--accent);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
  }

  #controls {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  #controls input, #controls select {
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid var(--muted);
    font-size: 16px;
  }

  #controls input { width: 60%; max-width: 250px; }
  #controls select { width: 30%; max-width: 150px; }

  #grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 16px;
    padding-bottom: 40px;
  }

  .libro {
    background: var(--card);
    border-radius: 6px;
    padding: 6px;
    text-align: center;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
  }

  .libro:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 18px rgba(0,0,0,0.25);
  }

  .placeholder {
    width: 100%;
    height: 160px;
    border-radius: 4px;
    margin-bottom: 6px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 8px 20px rgba(255,255,255,0.15);
    border-bottom: 8px solid #8B5E3C;
  }

  .titulo {
    font-size: 13px;
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    color: #3e3a36;
    margin-bottom: 6px;
  }

  .meta a {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    text-decoration: none;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: #fff;
    font-size: 12px;
    transition: background 0.2s;
  }

  .meta a:hover {
    background: #a67c4e;
  }

  .shelf {
    grid-column: 1 / -1;
    height: 16px;
    background: var(--shelf-bg);
    border-radius: 4px;
    margin-bottom: 16px;
  }

  p.center {
    text-align: center;
    color: var(--muted);
    margin-top: 20px;
  }

  footer {
    margin-top: 20px;
    text-align: center;
    color: var(--muted);
    font-size: 12px;
  }

  @media(max-width: 400px){
    #grid {
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
    }
    #controls input, #controls select {
      width: 90%;
      margin-bottom: 8px;
    }
  }
</style>
</head>
<body>
<header>
  <h1>Mi Biblioteca</h1>
  <div id="controls">
    <input id="buscar" type="search" placeholder="Buscar título..." aria-label="Buscar" />
    <select id="ordenar">
      <option value="alfabetico">Ordenar A-Z</option>
      <option value="recientes">Últimos agregados</option>
    </select>
  </div>
</header>
<p id="status" class="center">Cargando libros...</p>
<div id="grid" role="list"></div>
<footer>Accede desde tu Kobo y pulsa "Descargar" para bajar el archivo.</footer>

<script>
const folderId = "1-4G6gGNtt6KVS90AbWbtH3JlpetHrPEi";
const apiKey = "AIzaSyBZQnrDOm-40Mk6l9Qt48tObQtjWtM8IdA";
const pageSize = 1000;

let archivos = [];

function setStatus(msg){document.getElementById('status').textContent = msg}

function crearCard(file){
  const card = document.createElement('div'); 
  card.className = 'libro';

  const placeholderDiv = document.createElement('div');
  placeholderDiv.className = 'placeholder';
  // Imagen de estante de libros aleatoria desde Unsplash
  const imagenAleatoria = Math.floor(Math.random()*1000);
  placeholderDiv.style.backgroundImage = `url('https://source.unsplash.com/120x160/?books,library&sig=${imagenAleatoria}')`;

  const title = document.createElement('div'); 
  title.className = 'titulo'; 
  title.textContent = file.name;

  const meta = document.createElement('div'); 
  meta.className = 'meta';
  const link = document.createElement('a');
  link.href = `https://drive.google.com/uc?export=download&id=${file.id}`;
  link.textContent = 'Descargar';
  link.target = '_blank';
  meta.appendChild(link);

  card.appendChild(placeholderDiv);
  card.appendChild(title);
  card.appendChild(meta);

  return card;
}

async function listarArchivos() {
  setStatus('Obteniendo lista de archivos...');
  const endpoint = `https://www.googleapis.com/drive/v3/files`;
  const params = new URLSearchParams({
    q: `'${folderId}' in parents and trashed=false`,
    key: apiKey,
    fields: `nextPageToken, files(id,name,mimeType,thumbnailLink,webContentLink, createdTime)` ,
    pageSize: String(pageSize)
  });

  try{
    const res = await fetch(endpoint + '?' + params.toString());
    if(!res.ok) throw new Error(`Drive API responded ${res.status} ${res.statusText}`);
    const data = await res.json();
    archivos = data.files || [];
    mostrarArchivos();
  }catch(err){
    console.error(err);
    setStatus('Error al obtener archivos: ' + (err.message || err));
  }
}

function mostrarArchivos(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  if(archivos.length === 0){
    setStatus('No se encontraron libros en la carpeta.');
    return;
  }
  setStatus('');

  const orden = document.getElementById('ordenar').value;
  if(orden === 'alfabetico'){
    archivos.sort((a,b)=> a.name.localeCompare(b.name));
  } else {
    archivos.sort((a,b)=> new Date(b.createdTime) - new Date(a.createdTime));
  }

  // Insertar un estante después de cada fila
  const columnas = Math.floor(grid.offsetWidth / 136) || 5;
  archivos.forEach((file, index) => {
    grid.appendChild(crearCard(file));
    if ((index + 1) % columnas === 0) {
      const shelf = document.createElement('div');
      shelf.className = 'shelf';
      grid.appendChild(shelf);
    }
  });
}

document.getElementById('buscar').addEventListener('input', function(e){
  const q = e.target.value.toLowerCase().trim();
  document.querySelectorAll('.libro').forEach(card => {
    const title = card.querySelector('.titulo').textContent.toLowerCase();
    card.style.display = title.includes(q) ? '' : 'none';
  });
});

document.getElementById('ordenar').addEventListener('change', mostrarArchivos);

listarArchivos();
</script>
</body>
</html>
